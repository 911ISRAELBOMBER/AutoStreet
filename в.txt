ФормаСменыПароля
&НаСервере
Функция ВойтиНаСервере()
	ПользовательНайден=Справочник.Пользователи.ПустаяСсылка();
	Если НЕ Справочники.Пользователи.НайтиПоНаименованию(Логин,Истина).Пустая() Тогда
		ПользовательНайден=Справочники.Пользователи.НайтиПоНаименованию(Логин,Истина).Ссылка;
		Если ПользовательНайден.Пароль=Пароль Тогда
			Если НЕ ПользовательноНайден.ДатаВхода=Дата("01.01.0001 0:00:00") Тогда
				Если ТекущаяДата()>ДобавитьМесяц(НачалоМесяца(ПользовательНайден.ДатаВхода),1) Тогда
					ИзменитьДанныеНаСервере(ПользовательНайден, "Активность",Ложь);
					Сообщить("Вы заблокированы. Обратитесь к администратору");
				КонецЕсли;
			КонецЕсли;
			Возврат ПользовательНайден.Роль;
		Иначе
			УстановитьКоличествоПопыток(ПользовательНайден);
			Возврат Неопределено;
		КонецЕсли;
	Иначе
		Возврат Неопределено;
	КонецЕсли;
КонецФункции

&НаКлиенте
Процедура Войти(Команда)
	Роль=ВойтиНаСервере();
	Если НЕ Роль=Неопределено Тогда
		Если АктивностьПользователя(ПользовательНайден)=Истина Тогда
			ИзменитьДанныеНаСервере(ПользовательНайден, "КоличествоПопыток", 0);
			Если ВходПользователя(ПользовательНайден)=Дата("01.01.0001 0:00:00") Тогда
				ОткрытьФорму("ОбщаяФорма.ФормаСменыПароля", Новый Структура ("ПараметрПользователь", ПользовательНайден));
				Сообщить ("Измените пароль при первом входе");
			Иначе
				ИзменитьДанныеНаСервере(ПользовательНайден,"ДатаВхода",ТекущаяДата()));
				Если Роль=ПредопределенноеЗначение("Перечисление.Роли.Пользователь") Тогда
					Сообщить ("Вы успешно авторизовались");
				КонецЕсли;
				Если Роль=ПредопределенноеЗначение("Перечисление.Роли.Администратор") Тогда
					Сообщить ("Вы успешно авторизовались");
				КонецЕсли;
			КонецЕсли;
			ЭтаФорма.Закрыть();
		Иначе
			ИзменитьДанныеНаСервере(ПользовательНайден, "Активность", Ложь);
			Сообщить ("Вы ввели неправильный логин или пароль");
КонецПроцедуры

ФормаАвторизации 
&НаСервере
Функция ВойтиНаСервере()
	ПользовательНайден=Справочник.Пользователи.ПустаяСсылка();
	Если НЕ Справочники.Пользователи.НайтиПоНаименованию(Логин,Истина).Пустая() Тогда
		ПользовательНайден=Справочники.Пользователи.НайтиПоНаименованию(Логин,Истина).Ссылка;
		Если ПользовательНайден.Пароль=Пароль Тогда
			Если НЕ ПользовательноНайден.ДатаВхода=Дата("01.01.0001 0:00:00") Тогда
				Если ТекущаяДата()>ДобавитьМесяц(НачалоМесяца(ПользовательНайден.ДатаВхода),1) Тогда
					ИзменитьДанныеНаСервере(ПользовательНайден, "Активность",Ложь);
					Сообщить("Вы заблокированы. Обратитесь к администратору");
				КонецЕсли;
			КонецЕсли;
			Возврат ПользовательНайден.Роль;
		Иначе
			УстановитьКоличествоПопыток(ПользовательНайден);
			Возврат Неопределено;
		КонецЕсли;
	Иначе
		Возврат Неопределено;
	КонецЕсли;
КонецФункции

&НаКлиенте
Процедура Войти(Команда)
	Роль=ВойтиНаСервере();
	Если НЕ Роль=Неопределено Тогда
		Если АктивностьПользователя(ПользовательНайден)=Истина Тогда
			ИзменитьДанныеНаСервере(ПользовательНайден, "КоличествоПопыток", 0);
			Если ВходПользователя(ПользовательНайден)=Дата("01.01.0001 0:00:00") Тогда
				ОткрытьФорму("ОбщаяФорма.ФормаСменыПароля", Новый Структура ("ПараметрПользователь", ПользовательНайден));
				Сообщить ("Измените пароль при первом входе");
			Иначе
				ИзменитьДанныеНаСервере(ПользовательНайден,"ДатаВхода",ТекущаяДата()));
				Если Роль=ПредопределенноеЗначение("Перечисление.Роли.Пользователь") Тогда
					Сообщить ("Вы успешно авторизовались");
				КонецЕсли;
				Если Роль=ПредопределенноеЗначение("Перечисление.Роли.Администратор") Тогда
					Сообщить ("Вы успешно авторизовались");
				КонецЕсли;
			КонецЕсли;
			ЭтаФорма.Закрыть();
		Иначе
			ИзменитьДанныеНаСервере(ПользовательНайден, "Активность", Ложь);
			Сообщить ("Вы ввели неправильный логин или пароль");
КонецПроцедуры


